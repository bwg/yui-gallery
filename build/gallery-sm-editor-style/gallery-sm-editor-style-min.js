YUI.add("gallery-sm-editor-style",function(e,t){(function(){var t=e.config.doc,n=e.config.win,r=e.Editor.DOM,i="<span></span>",s=e.Base.create("editorStyle",e.Base,[],{styleCommands:{bold:{property:"fontWeight",value:"bold"},fontName:{property:"fontFamily"},fontSize:{property:"fontSize"},italic:{property:"fontStyle",value:"italic"},underline:{property:"textDecoration",value:"underline"}},styleKeyCommands:{},styleTags:"span",initializer:function(){this.supportedTags?this.supportedTags+=","+this.styleTags:this.supportedTags=this.styleTags,this.keyCommands&&(this.keyCommands=e.merge(this.keyCommands,this.styleKeyCommands)),this._attachStyleEvents()},destructor:function(){this._detachStyleEvents()},bold:function(){return this.command("bold","toggle"),this},italic:function(){return this.command("italic","toggle"),this},styles:function(e){var t={},n;if(e)for(n in e)e.hasOwnProperty(n)&&(t[n]=this.command(n,e[n]));else{var r=this.styleCommands;for(n in r)r.hasOwnProperty(n)&&(t[n]=this._queryCommandValue(n))}return t},underline:function(){return this.command("underline","toggle"),this},_attachStyleEvents:function(){if(this._styleEvents)return;this._styleEvents=[e.Do.before(this._styleBeforeExecCommand,this,"_execCommand",this),e.Do.before(this._styleBeforeQueryCommand,this,"_queryCommandValue",this)]},_detachStyleEvents:function(){this._styleEvents&&((new e.EventHandle(this._styleEvents)).detach(),this._styleEvents=null)},_execStyleCommand:function(e,t){var n=this.styleCommands[e],r=this.selection.range(),i,s;if(!r||!n)return;i=this._getStyleNodes(r),s=i.item(0)._node.style[n.property],this.boolCommands[e]&&"toggle"===t?s&&""!==s?s="":s=n.value:t?s=n.value||t:s="",i.setStyle(n.property,s)},_formatHTML:function(n){function s(t){var n=t.get("childNodes")._nodes;e.Array.each(n.reverse(),function(t){var n;t=e.one(t),n=t.get("parentNode"),r.isTextNode(t)?this._isBlockNode(n)?t.wrap(i):t.get("previousSibling")&&r.split(n,t):(t.test(this.supportedTags)?!this._isBlockNode(n)&&!n.test("a")&&(n.insert(t,"after"),this._isBlockNode(t)||(t.addClass(n.get("className")),r.copyStyles(n,t,u,{explicit:!0,overwrite:!1}))):t.replace(t.get("text")),s.call(this,t),r.isEmptyNode(t)&&t.remove(!0),t.removeAttribute("id"))},this)}var o,u=[],a=this.supportedTags;return e.Object.each(this.styleCommands,function(e){u.push(e.property)}),o=e.one(t.createDocumentFragment()).setHTML(n),s.call(this,o),o},_getHTML:function(t){return t=e.Editor.Base.prototype._getHTML.call(this,t),this.get("formatFn")(t).getHTML()},_getStyledAncestor:function(e,t){return e.ancestor(function(e){return r.isElementNode(e)?!!e._node.style[t]:!1},!0,this.selectors.input)},_getStyleNodes:function(t){var n,s=[];t.shrink(),n=t.parentNode().ancestor(this.styleTags,!0,this.selectors.input);if(n){if(t.toString()===n.get("text"))return new e.NodeList([n])}else n=e.Node.create(i);var o=t.startNode(),u=t.startOffset(),a=t.endNode(),f=t.endOffset();return t.traverse(function(e){if(!r.isTextNode(e))return;a===e&&f!==r.maxOffset(a)&&(e=r.split(e,f).get("previousSibling")),o===e&&u&&(e=r.split(e,u)),this._isStyleNode(e.get("parentNode"))?(e.get("nextSibling")&&r.split(e.get("parentNode"),e.get("nextSibling")),e.get("previousSibling")&&r.split(e.get("parentNode"),e),s.push(e.get("parentNode"))):s.push(e.wrap(n).get("parentNode"))},this),new e.NodeList(s)},_isBlockNode:function(t){return t=e.one(t),!r.isTextNode(t)&&(t.get("nodeName")==="#document-fragment"||t.test(this.blockTags))},_isStyleNode:function(t){return t=e.one(t),t&&!r.isTextNode(t)&&t.test(this.styleTags)},_setHTML:function(t){return t=this.get("formatFn")(t).getHTML(),e.Editor.Base.prototype._setHTML.call(this,t)},_queryStyleCommand:function(e){var t=this.styleCommands[e],n=this.selection.range().clone(),i,s,o;return n&&(i=n.shrink().parentNode(),s=this._getStyledAncestor(i,t.property),s||(s=i.ancestor(r.isElementNode,!0)),o=s.getStyle(t.property)),this.boolCommands[e]?o=o===t.value:""===o&&(o=null),o},_afterDelete:function(){this._clearCommandQueue(),this._updateSelection({force:!0})},_styleBeforeExecCommand:function(t,n){if(this.styleCommands[t]){var r=this._execStyleCommand(t,n);return new e.Do.Halt("Editor.Style prevented _execCommand",r)}},_styleBeforeQueryCommand:function(t){if(this.styleCommands[t]){var n=this._queryStyleCommand(t);return new e.Do.Halt("Editor.Style prevented _queryCommand",n)}}},{ATTRS:{formatFn:{readOnly:!0,setter:function(t){return e.bind(t,this)},validator:e.Lang.isFunction,valueFn:function(){return this._formatHTML}}}});e.namespace("Editor").Style=s})()},"@VERSION@",{requires:["gallery-sm-editor-base","gallery-sm-editor-dom","gallery-sm-editor-keys","gallery-sm-editor-queue","node-style"]});
